name: "Plan and Apply Terraform code"
description: "Combining plan && apply actions into one"

inputs:
  environment:
    type: string
    required: true
  region:
    type: string
    required: true
  iam-role:
    type: string
    required: true

runs:
  using: "composite"

  steps:

    - uses: hashicorp/setup-terraform@v2

    - name: Terraform plan
      run: terraform plan -var-file=${{ inputs.environment }}.tfvars
      shell: bash
      working-directory: ${{ format('terraform/environments/{0}', inputs.environment) }}

    - name: Terraform apply
      run: terraform apply -var-file=${{ inputs.environment }}.tfvars -auto-approve
      shell: bash
      working-directory: ${{ format('terraform/environments/{0}', inputs.environment) }}

    - name: 'Extract ip: ${{ inputs.environment }}'
      run: |
        terraform output ${{ inputs.environment }}_ec2_public_ip > ${{ inputs.environment }}_ip.txt

#        terraform output -json > ${{ inputs.environment }}_ips.json
#          jq -r '.${{ inputs.environment }}_ec2_public_ip.value' ${{ inputs.environment }}_ips.json > ${{ inputs.environment }}_ip.txt
      working-directory: ${{ format('terraform/environments/{0}', inputs.environment) }}
      shell: bash

    - name: 'Upload ip artifacts'
      uses: actions/upload-artifact@v4
      with:
        name: terraform ips
        paths: |
          ${{ inputs.environment }}_ip.txt
